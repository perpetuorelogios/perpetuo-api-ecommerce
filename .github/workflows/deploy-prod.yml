name: Deploy API PROD

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy API to server (PROD)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          port: 22
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "."
          target: "/var/www/perpetuorelogios/api/app"
          rm: true

      - name: Install dependencies and restart app with PM2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          port: 22
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            echo "ğŸš€ Deploy iniciado"

            # -----------------------------
            # Limpeza e InstalaÃ§Ã£o do Node
            # -----------------------------
            apt-get remove -y nodejs || true
            apt-get autoremove -y || true
            curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
            apt-get install -y nodejs
            npm install -g pm2

            # -----------------------------
            # InstalaÃ§Ã£o do App
            # -----------------------------
            cd /var/www/perpetuorelogios/api/app
            npm install

            # -----------------------------
            # PRISMA MIGRATE
            # -----------------------------
            # Agora injetamos a DIRECT_URL para o Prisma Migrate usar (Porta 5432)
            # O prisma.config.ts vai ler esta variÃ¡vel automaticamente.
            echo "âš¡ Rodando Prisma Migrate..."

            export DIRECT_URL="${{ secrets.PROD_DIRECT_URL }}"
            npx prisma generate
            npx prisma migrate deploy
            unset DIRECT_URL

            # -----------------------------
            # Gerar .env para o App Rodar
            # -----------------------------
            # O App em si (runtime) vai usar a DATABASE_URL (Porta 6543)
            echo "ğŸ“ Gerando arquivo .env para ProduÃ§Ã£o..."

            printf "NODE_ENV=prod\n" > .env
            printf "PORT=3000\n" >> .env
            # O app vai ler esta URL rÃ¡pida via Adapter:
            printf "DATABASE_URL=%s\n" "${{ secrets.PROD_DATABASE_URL }}" >> .env
            printf "REDIS_URL=%s\n" "${{ secrets.PROD_REDIS_URL }}" >> .env
            printf "JWT_SECRET=%s\n" "${{ secrets.JWT_SECRET }}" >> .env
            printf "JWT_EXPIRES_IN=1d\n" >> .env

            # -----------------------------
            # Build e Restart
            # -----------------------------
            npm run build || true
            pm2 restart app || pm2 start npm --name app -- run start
            pm2 save

            echo "âœ… Deploy finalizado com sucesso"