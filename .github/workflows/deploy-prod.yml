name: Deploy API PROD

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. SETUP & BUILD (No GitHub)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install & Build (CI)
        env:
          # VariÃ¡veis fakes apenas para o build nÃ£o quebrar
          DIRECT_URL: ${{ secrets.PROD_DIRECT_URL }}
          DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
        run: |
          npm ci
          npx prisma generate
          npm run build
          # Removemos node_modules para o upload ser leve
          rm -rf node_modules

      # 2. UPLOAD (Apenas o necessÃ¡rio)
      - name: Copy Built Files to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          port: 22
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Enviamos apenas o essencial. Note que NÃƒO enviamos o prisma.config.ts
          source: "dist,prisma,package.json,package-lock.json"
          target: "/var/www/perpetuorelogios/api/app"
          # rm: false garante Zero Downtime (nÃ£o apaga o site antes de atualizar)
          rm: false

      # 3. RUN (Servidor Leve)
      - name: Install Production Deps & Reload
        uses: appleboy/ssh-action@v1.0.3
        env:
          DB_URL: ${{ secrets.PROD_DATABASE_URL }}
          DIR_URL: ${{ secrets.PROD_DIRECT_URL }}
          REDIS_URL: ${{ secrets.PROD_REDIS_URL }}
          JWT_SEC: ${{ secrets.JWT_SECRET }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          port: 22
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: DB_URL,DIR_URL,REDIS_URL,JWT_SEC
          script: |
            set -e
            echo "ðŸš€ Deploy Only-Build Iniciado"

            cd /var/www/perpetuorelogios/api/app

            # -----------------------------
            # 1. Limpeza de Arquivos "Fantasmas"
            # -----------------------------
            # CORREÃ‡ÃƒO CRÃTICA: Apagamos qualquer rastro de prisma.config.ts antigo.
            # Isso forÃ§a o Prisma a usar apenas o schema.prisma e nossas variÃ¡veis.
            rm -f prisma.config.ts tsconfig.json tsup.config.ts

            # -----------------------------
            # 2. Instalar APENAS ProduÃ§Ã£o
            # -----------------------------
            echo "ðŸ“¦ Instalando dependÃªncias de produÃ§Ã£o..."
            npm ci --omit=dev

            # -----------------------------
            # 3. Gerar .env (Para a AplicaÃ§Ã£o)
            # -----------------------------
            echo "ðŸ“ Gerando .env..."
            printf "NODE_ENV=production\n" > .env
            printf "PORT=3000\n" >> .env
            printf "DATABASE_URL=\"%s\"\n" "$DB_URL" >> .env
            printf "REDIS_URL=\"%s\"\n" "$REDIS_URL" >> .env
            printf "JWT_SECRET=\"%s\"\n" "$JWT_SEC" >> .env
            printf "JWT_EXPIRES_IN=1d\n" >> .env

            # -----------------------------
            # 4. PRISMA (Truque do Direct URL)
            # -----------------------------
            echo "âš¡ Sincronizando Banco..."

            npx -y prisma generate

            # TRUQUE: Injetamos a URL Direta (5432) como DATABASE_URL apenas para este comando.
            # Como deletamos o prisma.config.ts acima, o Prisma vai obedecer essa variÃ¡vel.
            DATABASE_URL="$DIR_URL" npx -y prisma db push --accept-data-loss

            # -----------------------------
            # 5. RELOAD
            # -----------------------------
            echo "ðŸ”„ Reiniciando aplicaÃ§Ã£o..."

            # Garante que roda o arquivo compilado da pasta dist
            pm2 reload app --update-env || pm2 start dist/main.js --name app
            pm2 save

            echo "âœ… Deploy finalizado com Sucesso!"