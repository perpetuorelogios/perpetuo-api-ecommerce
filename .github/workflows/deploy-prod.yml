name: Deploy API PROD

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy API to server (PROD)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          port: 22
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "."
          target: "/var/www/perpetuorelogios/api/app"
          rm: true

      - name: Install dependencies and restart app with PM2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          port: 22
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            # Instalar Node.js (versão mais recente) usando NodeSource
            curl -fsSL https://deb.nodesource.com/setup_current.x | bash -
            apt-get install -y nodejs

            # Instalar PM2 globalmente
            npm install -g pm2

            cd /var/www/perpetuorelogios/api/app

            # Instalar dependências
            npm install

            # Build da aplicação, se necessário
            npm run build || true

            # Gerar Prisma Client e aplicar migrations
            npx prisma generate
            npx prisma migrate deploy

            # Configurar variáveis de ambiente para uso com Redis Cloud
            echo "NODE_ENV=prod" > .env
            echo "PORT=3000" >> .env
            echo "DATABASE_URL=${{ secrets.PROD_DATABASE_URL }}" >> .env
            echo "REDIS_URL=${{ secrets.PROD_REDIS_URL }}" >> .env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
            echo "JWT_EXPIRES_IN=1d" >> .env

            # Reiniciar/Startar a aplicação com PM2
            pm2 restart app || pm2 start npm --name app -- run start
            pm2 save