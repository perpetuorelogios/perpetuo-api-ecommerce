name: Deploy API PROD

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. SETUP NODE (No GitHub Actions)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 2. BUILD (No GitHub Actions - Economiza CPU do seu servidor)
      - name: Install & Build (CI)
        env:
          # VariÃ¡veis necessÃ¡rias apenas para o build (nÃ£o conectam no banco real aqui)
          DIRECT_URL: ${{ secrets.PROD_DIRECT_URL }}
          DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
        run: |
          npm ci
          npx prisma generate
          npm run build
          # Removemos node_modules para o upload ser rÃ¡pido
          rm -rf node_modules

      # 3. UPLOAD (Artifacts)
      - name: Copy Built Files to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          port: 22
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # MUDANÃ‡A 1: Enviamos a pasta 'dist' pronta + arquivos de config do Prisma
          source: "dist,prisma,package.json,package-lock.json,prisma.config.ts"
          target: "/var/www/perpetuorelogios/api/app"
          # MUDANÃ‡A 2: rm: false para NÃƒO APAGAR o site enquanto faz upload
          rm: false

      # 4. FINALIZAR NO SERVIDOR (SSH)
      - name: Install Production Deps & Reload
        uses: appleboy/ssh-action@v1.0.3
        env:
          # Mapeamos as senhas aqui para seguranÃ§a (evita erro de caracteres especiais)
          DB_URL: ${{ secrets.PROD_DATABASE_URL }}
          DIR_URL: ${{ secrets.PROD_DIRECT_URL }}
          REDIS_URL: ${{ secrets.PROD_REDIS_URL }}
          JWT_SEC: ${{ secrets.JWT_SECRET }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          port: 22
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Injetamos as variÃ¡veis no terminal SSH
          envs: DB_URL,DIR_URL,REDIS_URL,JWT_SEC
          script: |
            set -e
            echo "ðŸš€ Deploy Zero-Downtime Iniciado"

            cd /var/www/perpetuorelogios/api/app

            # -----------------------------
            # 1. Instalar DependÃªncias
            # -----------------------------
            # Precisamos instalar tudo para ler o prisma.config.ts
            echo "ðŸ“¦ Atualizando dependÃªncias..."
            npm ci

            # -----------------------------
            # 2. Gerar .env (Para o PM2 rodar o app)
            # -----------------------------
            echo "ðŸ“ Atualizando .env..."
            printf "NODE_ENV=production\n" > .env
            printf "PORT=3000\n" >> .env
            printf "DATABASE_URL=\"%s\"\n" "$DB_URL" >> .env
            printf "DIRECT_URL=\"%s\"\n" "$DIR_URL" >> .env
            printf "REDIS_URL=\"%s\"\n" "$REDIS_URL" >> .env
            printf "JWT_SECRET=\"%s\"\n" "$JWT_SEC" >> .env
            printf "JWT_EXPIRES_IN=1d\n" >> .env

            # -----------------------------
            # 3. PRISMA (Banco de Dados)
            # -----------------------------
            echo "âš¡ Sincronizando Banco de Dados..."

            # Gera o client com base no O.S. do servidor
            npx -y prisma generate

            # Roda o push usando as variÃ¡veis injetadas + arquivo config.ts que subiu no upload
            DATABASE_URL="$DB_URL" DIRECT_URL="$DIR_URL" npx -y prisma db push --accept-data-loss

            # -----------------------------
            # 4. LIMPEZA (Opcional, mas bom para economizar espaÃ§o)
            # -----------------------------
            echo "ðŸ§¹ Otimizando node_modules..."
            npm prune --production

            # -----------------------------
            # 5. RELOAD (Zero Downtime)
            # -----------------------------
            echo "ðŸ”„ Reiniciando aplicaÃ§Ã£o..."

            # O 'reload' sobe o novo cÃ³digo em paralelo e sÃ³ mata o velho quando o novo estiver pronto
            pm2 reload app --update-env || pm2 start dist/main.js --name app
            pm2 save

            echo "âœ… Deploy finalizado com Sucesso!"