name: Deploy API PROD

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy API to server (PROD)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          port: 22
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "."
          target: "/var/www/perpetuorelogios/api/app"
          rm: true

      - name: Install dependencies and restart app with PM2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          port: 22
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            echo "ðŸš€ Deploy Otimizado Iniciado"

            # -----------------------------
            # VerificaÃ§Ã£o do Node (Sem reinstalar)
            # -----------------------------
            node -v
            npm -v

            # -----------------------------
            # AtualizaÃ§Ã£o do CÃ³digo
            # -----------------------------
            cd /var/www/perpetuorelogios/api/app
            npm install

            # -----------------------------
            # PRISMA (Modo AutÃ´nomo)
            # -----------------------------
            echo "âš¡ Sincronizando Schema com o Banco..."

            # Injetamos a DIRECT_URL (Porta 5432) para alterar a estrutura
            export DIRECT_URL="${{ secrets.PROD_DIRECT_URL }}"

            npx prisma generate

            # AQUI ESTÃ A MÃGICA:
            # db push sincroniza o banco direto com o arquivo schema.prisma
            npx prisma db push --accept-data-loss

            unset DIRECT_URL

            # -----------------------------
            # Gerar .env para o App Rodar
            # -----------------------------
            echo "ðŸ“ Gerando arquivo .env para ProduÃ§Ã£o..."

            printf "NODE_ENV=prod\n" > .env
            printf "PORT=3000\n" >> .env
            # O app vai ler esta URL rÃ¡pida (Porta 6543)
            printf "DATABASE_URL=%s\n" "${{ secrets.PROD_DATABASE_URL }}" >> .env
            printf "REDIS_URL=%s\n" "${{ secrets.PROD_REDIS_URL }}" >> .env
            printf "JWT_SECRET=%s\n" "${{ secrets.JWT_SECRET }}" >> .env
            printf "JWT_EXPIRES_IN=1d\n" >> .env

            # -----------------------------
            # Build e Reload (Zero Downtime)
            # -----------------------------
            echo "ðŸ”¨ Buildando..."
            npm run build

            echo "ðŸ”„ Atualizando processo..."
            pm2 reload app --update-env || pm2 start npm --name app -- run start
            pm2 save

            echo "âœ… Deploy finalizado com sucesso"