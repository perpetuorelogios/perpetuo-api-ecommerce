name: Deploy API PROD

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. SETUP & BUILD (No GitHub)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install & Build (CI)
        env:
          # Vari√°veis fakes apenas para o build n√£o quebrar se houver valida√ß√£o
          DIRECT_URL: ${{ secrets.PROD_DIRECT_URL }}
          DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
        run: |
          npm ci
          npx prisma generate
          npm run build
          # Removemos node_modules para o upload ser leve
          rm -rf node_modules

      # 2. UPLOAD (Apenas o necess√°rio para produ√ß√£o)
      - name: Copy Built Files to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          port: 22
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # MUDAN√áA: Removemos 'prisma.config.ts'.
          # Enviamos apenas 'dist' (seu c√≥digo compilado), 'prisma' (schema) e 'package.json'
          source: "dist,prisma,package.json,package-lock.json"
          target: "/var/www/perpetuorelogios/api/app"
          # rm: false garante que o site n√£o saia do ar (n√£o apaga a pasta antes)
          rm: false

      # 3. RUN (Servidor Leve)
      - name: Install Production Deps & Reload
        uses: appleboy/ssh-action@v1.0.3
        env:
          DB_URL: ${{ secrets.PROD_DATABASE_URL }}
          DIR_URL: ${{ secrets.PROD_DIRECT_URL }}
          REDIS_URL: ${{ secrets.PROD_REDIS_URL }}
          JWT_SEC: ${{ secrets.JWT_SECRET }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          port: 22
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: DB_URL,DIR_URL,REDIS_URL,JWT_SEC
          script: |
            set -e
            echo "üöÄ Deploy Only-Build Iniciado"

            cd /var/www/perpetuorelogios/api/app

            # -----------------------------
            # 1. Instalar APENAS Produ√ß√£o
            # -----------------------------
            # Como removemos o prisma.config.ts, n√£o precisamos mais de 'typescript' ou 'tsx'
            # Isso deixa a instala√ß√£o muito mais r√°pida e leve.
            echo "üì¶ Instalando depend√™ncias de produ√ß√£o..."
            npm ci --omit=dev

            # -----------------------------
            # 2. Gerar .env (Para a Aplica√ß√£o)
            # -----------------------------
            echo "üìù Gerando .env..."
            printf "NODE_ENV=production\n" > .env
            printf "PORT=3000\n" >> .env
            printf "DATABASE_URL=\"%s\"\n" "$DB_URL" >> .env
            printf "REDIS_URL=\"%s\"\n" "$REDIS_URL" >> .env
            printf "JWT_SECRET=\"%s\"\n" "$JWT_SEC" >> .env
            printf "JWT_EXPIRES_IN=1d\n" >> .env

            # -----------------------------
            # 3. PRISMA (Truque do Direct URL)
            # -----------------------------
            echo "‚ö° Sincronizando Banco..."

            npx -y prisma generate

            # TRUQUE: Como n√£o temos o arquivo de config para gerenciar a Direct URL,
            # n√≥s for√ßamos a vari√°vel DATABASE_URL a ser a URL Direta (5432) apenas para este comando.
            # O Prisma vai achar que √© a URL principal e vai fazer o push sem erro.
            DATABASE_URL="$DIR_URL" npx -y prisma db push --accept-data-loss

            # -----------------------------
            # 4. RELOAD
            # -----------------------------
            echo "üîÑ Reiniciando aplica√ß√£o..."

            # Garante que roda o arquivo compilado da pasta dist
            pm2 reload app --update-env || pm2 start dist/main.js --name app
            pm2 save

            echo "‚úÖ Deploy finalizado com Sucesso!"