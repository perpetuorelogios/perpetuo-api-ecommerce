name: Deploy API PROD

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy API to server (PROD)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          port: 22
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "."
          target: "/var/www/perpetuorelogios/api/app"
          rm: true

      - name: Install dependencies and restart app with PM2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          port: 22
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            echo "ğŸš€ Deploy iniciado"

            # -----------------------------
            # Node.js 20 LTS (NodeSource)
            # -----------------------------
            curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
            apt-get install -y nodejs

            node -v
            npm -v

            # -----------------------------
            # PM2
            # -----------------------------
            npm install -g pm2

            # -----------------------------
            # App
            # -----------------------------
            cd /var/www/perpetuorelogios/api/app

            # DependÃªncias
            npm install

            # Build (nÃ£o quebra se nÃ£o existir)
            npm run build || true

            # -----------------------------
            # Prisma (produÃ§Ã£o)
            # -----------------------------
            npx prisma generate
            npx prisma migrate deploy

            # -----------------------------
            # Environment
            # -----------------------------
            echo "NODE_ENV=prod" > .env
            echo "PORT=3000" >> .env
            echo "DATABASE_URL=${{ secrets.PROD_DATABASE_URL }}" >> .env
            echo "REDIS_URL=${{ secrets.PROD_REDIS_URL }}" >> .env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
            echo "JWT_EXPIRES_IN=1d" >> .env

            # -----------------------------
            # PM2 start / restart
            # -----------------------------
            pm2 restart app || pm2 start npm --name app -- run start
            pm2 save

            echo "âœ… Deploy finalizado com sucesso"
