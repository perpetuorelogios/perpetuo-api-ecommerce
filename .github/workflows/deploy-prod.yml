name: Deploy API PROD

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy API to server (PROD)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          port: 22
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "."
          target: "/var/www/perpetuorelogios/api/app"
          rm: true

      - name: Install dependencies and restart app with PM2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          port: 22
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            echo "ğŸš€ Deploy iniciado"

            # -----------------------------
            # REMOVER Node antigo
            # -----------------------------
            # Removemos para garantir uma instalaÃ§Ã£o limpa, mas se quiser velocidade
            # futura, vocÃª pode remover estas linhas de apt-get remove.
            apt-get remove -y nodejs || true
            apt-get autoremove -y || true

            # -----------------------------
            # Node.js 20 LTS
            # -----------------------------
            curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
            apt-get install -y nodejs

            node -v
            npm -v

            # -----------------------------
            # PM2 e DependÃªncias Globais
            # -----------------------------
            npm install -g pm2

            # -----------------------------
            # App Install
            # -----------------------------
            cd /var/www/perpetuorelogios/api/app
            npm install

            # -----------------------------
            # PRISMA MIGRATE (Porta 5432 - Session)
            # -----------------------------
            # Define a variÃ¡vel APENAS na memÃ³ria para rodar a migraÃ§Ã£o
            # Isso evita erros de IPv4 e permite alterar o banco
            echo "âš¡ Rodando Prisma Migrate..."
            export DATABASE_URL="${{ secrets.PROD_MIGRATION_URL }}"

            npx prisma generate
            npx prisma migrate deploy

            # Limpa a variÃ¡vel da memÃ³ria para nÃ£o confundir o prÃ³ximo passo
            unset DATABASE_URL

            # -----------------------------
            # Gerar .env Final (Porta 6543 - Transaction)
            # -----------------------------
            # Usamos printf para evitar erros com caracteres especiais na senha
            echo "ğŸ“ Gerando arquivo .env para ProduÃ§Ã£o..."

            printf "NODE_ENV=prod\n" > .env
            printf "PORT=3000\n" >> .env
            printf "DATABASE_URL=%s\n" "${{ secrets.PROD_DATABASE_URL }}" >> .env
            printf "REDIS_URL=%s\n" "${{ secrets.PROD_REDIS_URL }}" >> .env
            printf "JWT_SECRET=%s\n" "${{ secrets.JWT_SECRET }}" >> .env
            printf "JWT_EXPIRES_IN=1d\n" >> .env

            # -----------------------------
            # Build
            # -----------------------------
            npm run build || true

            # -----------------------------
            # PM2 Restart
            # -----------------------------
            # O app vai ler o .env criado acima e conectar na porta 6543 (rÃ¡pida)
            pm2 restart app || pm2 start npm --name app -- run start
            pm2 save

            echo "âœ… Deploy finalizado com sucesso"