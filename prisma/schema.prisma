// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider   = "prisma-client"
  output     = "../src/generated/"
  engineType = "client"
}

datasource db {
  provider = "postgresql"
}

enum InventoryMovementType {
  in
  out
  reserve
  release
  adjust
}

enum InventoryMovementReferenceType {
  order
  cancel
  return
  manual
}

enum CouponType {
  percentage
  fixed
}

enum OrderStatus {
  draft
  pending
  paid
  completed
  canceled
  refunded
}

enum OrderStatusChangedBy {
  system
  admin
  customer
}

enum PaymentMethod {
  credit_card
  pix
  boleto
  transfer
}

enum PaymentStatus {
  pending
  paid
  failed
  refunded
}

enum PaymentProfileType {
  credit_card
  debit_card
  wallet
}

enum ShippingStatus {
  pending
  shipped
  delivered
  returned
}

enum UserRole {
  admin
  seller
  customer
}

enum PaymentLinkBillingType {
  UNDEFINED
  CREDIT_CARD
  BOLETO
  PIX
  TRANSFER
}

enum PaymentLinkChargeType {
  DETACHED
  INSTALLMENT
  RECURRENT
}

enum PaymentLinkSubscriptionCycle {
  MONTHLY
  WEEKLY
  YEARLY
}

enum PaymentLinkStatus {
  pending
  paid
  failed
  canceled
}

enum ProductRequestStatus {
  pending
  quoted
  completed
  canceled
}

model Customer {
  id              String           @id @default(uuid())
  name            String
  email           String           @unique
  password        String
  document        String
  phone           String
  role            UserRole         @default(customer)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  deletedAt       DateTime?
  addresses       Address[]
  orders          Order[]
  paymentProfiles PaymentProfile[]
  productRequests ProductRequest[]
}

model Address {
  id         String    @id @default(uuid())
  customerId String
  street     String
  number     String
  complement String?
  city       String
  state      String
  zipCode    String
  isDefault  Boolean   @default(false)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?
  customer   Customer  @relation(fields: [customerId], references: [id])
  orders     Order[]
}

model Product {
  id                 String              @id @default(uuid())
  name               String
  brand              String
  model              String
  sku                String              @unique
  price              Decimal
  description        String?
  isPreorder         Boolean             @default(false)
  active             Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  deletedAt          DateTime?
  inventory          Inventory?
  inventoryMovements InventoryMovement[]
  orderItems         OrderItem[]
  productRequests    ProductRequest[]
}

model ProductRequest {
  id             String               @id @default(uuid())
  customerId     String
  productId      String
  paymentLinkId  String?              @unique
  quantity       Int
  status         ProductRequestStatus @default(pending)
  paymentLinkUrl String?
  notes          String?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  deletedAt      DateTime?
  customer       Customer             @relation(fields: [customerId], references: [id])
  product        Product              @relation(fields: [productId], references: [id])
  paymentLink    PaymentLink?         @relation("ProductRequestPaymentLink", fields: [paymentLinkId], references: [id])
  order          Order?
}

model PaymentLink {
  id                  String                        @id @default(uuid())
  provider            String
  providerId          String                        @unique
  url                 String
  name                String
  description         String?
  value               Decimal
  billingType         PaymentLinkBillingType
  chargeType          PaymentLinkChargeType
  dueDateLimitDays    Int?
  maxInstallmentCount Int?
  subscriptionCycle   PaymentLinkSubscriptionCycle?
  notificationEnabled Boolean?                      @default(true)
  status              PaymentLinkStatus             @default(pending)
  createdAt           DateTime                      @default(now())
  updatedAt           DateTime                      @updatedAt
  deletedAt           DateTime?
  productRequest      ProductRequest?               @relation("ProductRequestPaymentLink")
}

model Inventory {
  id                String    @id @default(uuid())
  productId         String    @unique
  quantityAvailable Int
  quantityReserved  Int
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?
  product           Product   @relation(fields: [productId], references: [id])
}

model InventoryMovement {
  id            String                         @id @default(uuid())
  productId     String
  type          InventoryMovementType
  quantity      Int
  referenceType InventoryMovementReferenceType
  referenceId   String
  createdAt     DateTime                       @default(now())
  updatedAt     DateTime                       @updatedAt
  deletedAt     DateTime?
  product       Product                        @relation(fields: [productId], references: [id])
}

model Coupon {
  id                String     @id @default(uuid())
  code              String     @unique
  type              CouponType
  value             Decimal
  maxDiscountAmount Decimal?
  minOrderAmount    Decimal?
  usageLimit        Int?
  usedCount         Int        @default(0)
  startsAt          DateTime?
  expiresAt         DateTime?
  active            Boolean    @default(true)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  deletedAt         DateTime?
  orders            Order[]
}

model Order {
  id               String               @id @default(uuid())
  customerId       String
  addressId        String
  couponId         String?
  productRequestId String?              @unique
  isPreorder       Boolean              @default(false)
  status           OrderStatus
  subtotalAmount   Decimal
  discountAmount   Decimal
  totalAmount      Decimal
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  deletedAt        DateTime?
  customer         Customer             @relation(fields: [customerId], references: [id])
  address          Address              @relation(fields: [addressId], references: [id])
  coupon           Coupon?              @relation(fields: [couponId], references: [id])
  productRequest   ProductRequest?      @relation(fields: [productRequestId], references: [id])
  items            OrderItem[]
  payment          Payment?
  shipping         Shipping?
  statusHistory    OrderStatusHistory[]
}

model OrderItem {
  id         String    @id @default(uuid())
  orderId    String
  productId  String
  quantity   Int
  unitPrice  Decimal
  totalPrice Decimal
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?
  order      Order     @relation(fields: [orderId], references: [id])
  product    Product   @relation(fields: [productId], references: [id])
}

model OrderStatusHistory {
  id         String               @id @default(uuid())
  orderId    String
  fromStatus OrderStatus
  toStatus   OrderStatus
  changedBy  OrderStatusChangedBy
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt
  deletedAt  DateTime?
  order      Order                @relation(fields: [orderId], references: [id])
}

model Payment {
  id               String               @id @default(uuid())
  orderId          String               @unique
  paymentProfileId String?
  method           PaymentMethod
  amount           Decimal
  installments     Int?
  status           PaymentStatus
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  deletedAt        DateTime?
  order            Order                @relation(fields: [orderId], references: [id])
  paymentProfile   PaymentProfile?      @relation(fields: [paymentProfileId], references: [id])
  transactions     PaymentTransaction[]
}

model PaymentProfile {
  id              String             @id @default(uuid())
  customerId      String
  type            PaymentProfileType
  brand           String
  last4           String
  holderName      String
  expirationMonth Int
  expirationYear  Int
  provider        String
  externalToken   String
  isDefault       Boolean            @default(false)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  deletedAt       DateTime?
  customer        Customer           @relation(fields: [customerId], references: [id])
  payments        Payment[]
}

model PaymentTransaction {
  id         String    @id @default(uuid())
  paymentId  String
  provider   String
  externalId String
  status     String
  payload    Json
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?
  payment    Payment   @relation(fields: [paymentId], references: [id])
}

model Shipping {
  id           String         @id @default(uuid())
  orderId      String         @unique
  status       ShippingStatus
  carrier      String?
  trackingCode String?
  shippedAt    DateTime?
  deliveredAt  DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  deletedAt    DateTime?
  order        Order          @relation(fields: [orderId], references: [id])
}

model QueueFailedJob {
  id        String    @id @default(uuid())
  queue     String
  jobId     String
  error     String
  payload   Json
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

model QueueProcessedEvent {
  id        String    @id @default(uuid())
  queue     String
  jobId     String
  event     String
  payload   Json
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}
